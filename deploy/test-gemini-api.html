<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API 测试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        input[type="file"] {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Gemini API 连接测试</h1>
        
        <div class="test-section">
            <h3>📋 当前配置</h3>
            <div id="config-info"></div>
        </div>

        <div class="test-section">
            <h3>🌐 API 连通性测试</h3>
            <button onclick="testAPIConnectivity()">测试 API 连接</button>
            <div id="connectivity-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>🖼️ 图片上传测试</h3>
            <input type="file" id="test-image" accept="image/*">
            <button onclick="testImageUpload()">测试图片生成</button>
            <div id="image-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>📝 完整 API 调用测试</h3>
            <button onclick="testFullAPI()">完整测试</button>
            <div id="full-log" class="log"></div>
        </div>
    </div>

    <script>
        // 配置信息
        const CONFIG = {
            API_BASE_URL: 'https://api.tu-zi.com/v1',
            API_KEY: 'sk-3RNycSK4jptF86qmwtFAzYNiNAKEt0i1xNZZEufKs6OmU0Mm',
            MODEL_NAME: 'gemini-2.5-flash-image'
        };

        // 显示配置信息
        document.getElementById('config-info').innerHTML = `
            <div><strong>API Base URL:</strong> ${CONFIG.API_BASE_URL}</div>
            <div><strong>API Key:</strong> ${CONFIG.API_KEY.substring(0, 10)}...</div>
            <div><strong>Model Name:</strong> ${CONFIG.MODEL_NAME}</div>
        `;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        // 测试 API 连通性
        async function testAPIConnectivity() {
            const logId = 'connectivity-log';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, '开始测试 API 连通性...', 'info');
            
            // 测试不同的端点
            const endpoints = [
                '/chat/completions',
                '/v1/chat/completions',
                '/completions',
                '/v1/completions',
                '/images/generations',
                '/v1/images/generations'
            ];

            for (const endpoint of endpoints) {
                try {
                    log(logId, `测试端点: ${CONFIG.API_BASE_URL}${endpoint}`, 'info');
                    
                    const response = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${CONFIG.API_KEY}`
                        },
                        body: JSON.stringify({
                            model: CONFIG.MODEL_NAME,
                            messages: [{
                                role: 'user',
                                content: 'test'
                            }]
                        })
                    });

                    log(logId, `响应状态: ${response.status} ${response.statusText}`, 
                        response.ok ? 'success' : 'error');
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(logId, `✅ 端点 ${endpoint} 可用!`, 'success');
                        log(logId, `响应数据: ${JSON.stringify(data, null, 2)}`, 'info');
                        break;
                    }
                } catch (error) {
                    log(logId, `❌ 端点 ${endpoint} 错误: ${error.message}`, 'error');
                }
            }
        }

        // 测试图片上传
        async function testImageUpload() {
            const logId = 'image-log';
            const fileInput = document.getElementById('test-image');
            
            document.getElementById(logId).innerHTML = '';
            
            if (!fileInput.files[0]) {
                log(logId, '请先选择一张图片', 'error');
                return;
            }

            const file = fileInput.files[0];
            log(logId, `开始测试图片: ${file.name} (${file.size} bytes)`, 'info');

            try {
                // 转换为 base64
                const base64 = await fileToBase64(file);
                log(logId, `图片转换为 base64 成功 (${base64.length} 字符)`, 'success');

                // 测试 API 调用
                const prompt = "将上传的人像转换为美式风格的专业 headshot";
                
                const requestBody = {
                    model: CONFIG.MODEL_NAME,
                    messages: [{
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: prompt
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: `data:${file.type};base64,${base64}`
                                }
                            }
                        ]
                    }],
                    max_tokens: 1000
                };

                log(logId, '发送 API 请求...', 'info');
                log(logId, `请求体大小: ${JSON.stringify(requestBody).length} 字符`, 'info');

                const response = await fetch(`${CONFIG.API_BASE_URL}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                });

                log(logId, `API 响应: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');

                const responseText = await response.text();
                log(logId, `响应内容: ${responseText}`, response.ok ? 'success' : 'error');

            } catch (error) {
                log(logId, `❌ 测试失败: ${error.message}`, 'error');
            }
        }

        // 完整 API 测试
        async function testFullAPI() {
            const logId = 'full-log';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, '开始完整 API 测试...', 'info');
            
            // 测试所有可能的 API 格式
            const testCases = [
                {
                    name: 'Chat Completions (文本)',
                    endpoint: '/chat/completions',
                    body: {
                        model: CONFIG.MODEL_NAME,
                        messages: [{
                            role: 'user',
                            content: '生成一张专业头像照片'
                        }]
                    }
                },
                {
                    name: 'Images Generation',
                    endpoint: '/images/generations',
                    body: {
                        model: CONFIG.MODEL_NAME,
                        prompt: '专业头像照片',
                        n: 1,
                        size: '512x512'
                    }
                },
                {
                    name: 'Completions',
                    endpoint: '/completions',
                    body: {
                        model: CONFIG.MODEL_NAME,
                        prompt: '生成一张专业头像照片',
                        max_tokens: 100
                    }
                }
            ];

            for (const testCase of testCases) {
                try {
                    log(logId, `\n测试: ${testCase.name}`, 'info');
                    log(logId, `端点: ${CONFIG.API_BASE_URL}${testCase.endpoint}`, 'info');
                    
                    const response = await fetch(`${CONFIG.API_BASE_URL}${testCase.endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${CONFIG.API_KEY}`
                        },
                        body: JSON.stringify(testCase.body)
                    });

                    log(logId, `状态: ${response.status} ${response.statusText}`, 
                        response.ok ? 'success' : 'error');
                    
                    const responseText = await response.text();
                    log(logId, `响应: ${responseText.substring(0, 200)}...`, 
                        response.ok ? 'success' : 'error');

                } catch (error) {
                    log(logId, `❌ ${testCase.name} 失败: ${error.message}`, 'error');
                }
            }
        }

        // 文件转 base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>